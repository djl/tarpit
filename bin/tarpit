#!/usr/bin/env bash
#/ Usage: tarpit [<options>] <backup>
#/
#/ Options:
#/   -c <directory>   The config directory
#/   -h               Show this message and exit

PROGNAME="$(basename $0)"
CONFIG_DIR="$HOME/.tarpit"

fail() {
  echo "$PROGNAME: $1" >&2
  exit 1
}

backups() {
  find "$1" -type f | xargs basename
  exit 0
}

usage() {
  grep "^#/" $0 | cut -c4- >&2
  exit 2
}

while getopts :hc: o; do
  case "$o" in
    c) CONFIG_DIR="$OPTARG" ;;
    h) usage ;;
    ?) fail "Invalid option: -$OPTARG" ;;
  esac
done

shift $((OPTIND-1))

BACKUP="$1"

[ -d "$CONFIG_DIR" ] || exit
[ -n "$BACKUP" ] || backups $CONFIG_DIR
[ -f "$CONFIG_DIR/$BACKUP" ] || fail "Unknown backup '$BACKUP'"

unset ARCHIVE EXCLUDE FILES KEYFILE

source "$CONFIG_DIR/$BACKUP"

cmd="tarsnap -c -f $ARCHIVE"

if [ -n "$EXCLUDE" ]; then
  for e in "${EXCLUDE[@]}"; do
    cmd="$cmd --exclude $e"
  done
fi

[ -n "$KEYFILE" ] && cmd="$cmd --keyfile $KEYFILE"

$cmd "${FILES[@]}"
